/*
 * Copyright 2016 Duncan Tebbs
 * Distributed under the MIT/X11 software license, see the accompanying
 * file COPYING or http://www.opensource.org/licenses/mit-license.php.
 */

#include <bitc/crypto/aes_util.h>      // for read_aes_file, etc
#include <bitc/cstr.h>
#include <bitc/util.h>

#include <assert.h>                     // for assert
#include <stddef.h>                     // for size_t
#include <stdint.h>                     // for uint8_t
#include <stdio.h>                      // for printf, NULL
#include <stdlib.h>                     // for free
#include <string.h>                     // for strlen, memcmp
#include <stdbool.h>                    // for bool, true
#include <unistd.h>                     // for unlink

#include "libtest.h"

static const char s_password[] = "test_libbitc_password";
static const char filename[] = "aes_util.dat";

static const char s_plaintext_0[417+1] = "Lorem ipsum dolor sit amet, consectetur adipiscing elit. Phasellus cursus, tellus at commodo tristique, nisi mi euismod erat, at fringilla ligula quam semper nibh. Cras blandit venenatis venenatis. Curabitur sollicitudin fermentum cursus. Aliquam gravida augue eu tortor commodo, a consectetur nulla convallis. Nullam id mattis purus. Sed nec velit quis magna finibus suscipit. Aenean ornare accumsan ipsum at tempor.";
static const uint8_t s_ciphertext_0[432] = {
0x9b,0xba,0x78,0x51,0x72,0x6b,0x4d,0x16,0x5b,0x16,0x6e,0xb1,0xcd,0x95,0xc7,0xb0,
0xc5,0x4b,0x8c,0x85,0x0e,0xcc,0x35,0xb5,0x3f,0xfb,0xe1,0x4f,0xfb,0x68,0x6c,0x53,
0xac,0x43,0x2e,0x93,0x16,0x01,0x95,0x7d,0xe2,0x5d,0x79,0x90,0xe3,0xc5,0x0e,0xd1,
0xb8,0x54,0xe0,0x9b,0xc9,0xa2,0xe8,0x67,0x2d,0x51,0xe0,0xdf,0x30,0x0e,0xd5,0x62,
0x18,0x05,0xdf,0x7c,0x17,0xa8,0xf1,0x08,0xdc,0xfc,0x26,0xa8,0x8c,0xde,0xd5,0x31,
0x61,0x2f,0x07,0x9d,0x2c,0x11,0xd6,0xfb,0xe5,0x7c,0x71,0x32,0xad,0x7f,0x6f,0x15,
0x62,0x9b,0xba,0x7a,0x76,0x12,0x55,0xfe,0xc6,0x1c,0xf4,0x75,0xe5,0xe4,0x47,0x86,
0xd4,0x41,0x7e,0xf0,0x0d,0xfb,0x74,0x16,0xa5,0x27,0xa5,0xfd,0xbf,0xd7,0xba,0x4c,
0x11,0x4a,0x1e,0x12,0xf6,0x62,0xd1,0x5f,0x21,0xb9,0xbd,0xd6,0x64,0x5c,0x2b,0x34,
0x92,0xd7,0x58,0x4c,0x31,0xb3,0xeb,0x16,0x3d,0xa9,0x79,0x4a,0xf2,0xf1,0xe6,0xb4,
0x99,0x6e,0xbe,0x14,0x3b,0x63,0xea,0xaa,0xce,0x08,0x49,0x1e,0xf8,0xf7,0xa7,0x47,
0xb2,0x0c,0xb0,0x6e,0x92,0xda,0x15,0x8f,0x82,0x8d,0x1c,0xbe,0x4a,0x13,0xec,0xa6,
0xce,0xa4,0xd0,0x9f,0x3e,0x64,0x76,0x70,0xa1,0xd9,0x3d,0x1a,0xa7,0x07,0xa7,0xb2,
0x93,0x16,0xba,0xbf,0xa3,0x3e,0x60,0x14,0x28,0x58,0x4d,0x07,0xb8,0x0c,0x62,0x08,
0xd9,0x48,0x3b,0xf4,0x44,0x90,0xed,0x29,0x02,0x55,0xdf,0x6d,0x00,0x36,0x17,0x5a,
0xf1,0x24,0xe9,0xd1,0x0e,0xbe,0x8c,0xba,0x32,0xba,0x3b,0x97,0xef,0xc1,0xcb,0x5d,
0x7a,0x66,0x19,0x25,0xeb,0x35,0xef,0xbc,0x4e,0x50,0x34,0xcf,0x32,0xbf,0x67,0xef,
0x96,0x35,0xdb,0x3e,0x41,0x2f,0xea,0x0c,0xee,0xe0,0xcf,0x10,0x15,0x4d,0x36,0x3a,
0x0b,0x11,0xb4,0xbb,0xab,0xfc,0x3c,0x2d,0x02,0x0b,0x0f,0xad,0x36,0xc5,0xe5,0x5e,
0xb1,0x01,0x19,0x8a,0x12,0xfe,0xcd,0x7a,0x2c,0x6c,0x3c,0x22,0xbd,0x40,0x90,0x34,
0x48,0x06,0x3e,0x9e,0xef,0x76,0x86,0xd0,0x07,0x79,0xc1,0x77,0xb3,0x7f,0xfb,0xf2,
0x28,0xc5,0x61,0x70,0xeb,0x6f,0xa4,0xa2,0x19,0xdc,0x57,0xf6,0xb0,0xe0,0x81,0x74,
0xcd,0xa1,0xdb,0xc8,0x2e,0x96,0xd6,0x43,0x4b,0x48,0xd3,0x6f,0x71,0xa5,0x41,0xe3,
0x21,0x93,0x6b,0x08,0x11,0x4f,0x1a,0xbd,0xa8,0x37,0xac,0xe9,0x62,0x64,0xaf,0x44,
0x6d,0x6e,0xda,0x4a,0x14,0x5c,0xc0,0xea,0xfd,0xc7,0x28,0x1f,0x2b,0xcc,0x73,0x8d,
0x54,0x32,0xc7,0xfb,0xcb,0x58,0x8a,0x95,0x6f,0x99,0xb6,0x94,0x18,0x7f,0x79,0x79,
0x8c,0x03,0xec,0x84,0x17,0x54,0xe2,0x7c,0x24,0x88,0x8a,0x85,0xa2,0x77,0x25,0x8f,
};

static const char s_plaintext_1[400+1] = "Lorem ipsum dolor sit amet, consectetur adipiscing elit. Phasellus cursus, tellus at commodo tristique, nisi mi euismod erat, at fringilla ligula quam semper nibh. Cras blandit venenatis venenatis. Curabitur sollicitudin fermentum cursus. Aliquam gravida augue eu tortor commodo, a consectetur nulla convallis. Nullam id mattis purus. Sed nec velit quis magna finibus suscipit. Aenean ornare accumsan";
static const uint8_t s_ciphertext_1[416] = {
0x9b,0xba,0x78,0x51,0x72,0x6b,0x4d,0x16,0x5b,0x16,0x6e,0xb1,0xcd,0x95,0xc7,0xb0,
0xc5,0x4b,0x8c,0x85,0x0e,0xcc,0x35,0xb5,0x3f,0xfb,0xe1,0x4f,0xfb,0x68,0x6c,0x53,
0xac,0x43,0x2e,0x93,0x16,0x01,0x95,0x7d,0xe2,0x5d,0x79,0x90,0xe3,0xc5,0x0e,0xd1,
0xb8,0x54,0xe0,0x9b,0xc9,0xa2,0xe8,0x67,0x2d,0x51,0xe0,0xdf,0x30,0x0e,0xd5,0x62,
0x18,0x05,0xdf,0x7c,0x17,0xa8,0xf1,0x08,0xdc,0xfc,0x26,0xa8,0x8c,0xde,0xd5,0x31,
0x61,0x2f,0x07,0x9d,0x2c,0x11,0xd6,0xfb,0xe5,0x7c,0x71,0x32,0xad,0x7f,0x6f,0x15,
0x62,0x9b,0xba,0x7a,0x76,0x12,0x55,0xfe,0xc6,0x1c,0xf4,0x75,0xe5,0xe4,0x47,0x86,
0xd4,0x41,0x7e,0xf0,0x0d,0xfb,0x74,0x16,0xa5,0x27,0xa5,0xfd,0xbf,0xd7,0xba,0x4c,
0x11,0x4a,0x1e,0x12,0xf6,0x62,0xd1,0x5f,0x21,0xb9,0xbd,0xd6,0x64,0x5c,0x2b,0x34,
0x92,0xd7,0x58,0x4c,0x31,0xb3,0xeb,0x16,0x3d,0xa9,0x79,0x4a,0xf2,0xf1,0xe6,0xb4,
0x99,0x6e,0xbe,0x14,0x3b,0x63,0xea,0xaa,0xce,0x08,0x49,0x1e,0xf8,0xf7,0xa7,0x47,
0xb2,0x0c,0xb0,0x6e,0x92,0xda,0x15,0x8f,0x82,0x8d,0x1c,0xbe,0x4a,0x13,0xec,0xa6,
0xce,0xa4,0xd0,0x9f,0x3e,0x64,0x76,0x70,0xa1,0xd9,0x3d,0x1a,0xa7,0x07,0xa7,0xb2,
0x93,0x16,0xba,0xbf,0xa3,0x3e,0x60,0x14,0x28,0x58,0x4d,0x07,0xb8,0x0c,0x62,0x08,
0xd9,0x48,0x3b,0xf4,0x44,0x90,0xed,0x29,0x02,0x55,0xdf,0x6d,0x00,0x36,0x17,0x5a,
0xf1,0x24,0xe9,0xd1,0x0e,0xbe,0x8c,0xba,0x32,0xba,0x3b,0x97,0xef,0xc1,0xcb,0x5d,
0x7a,0x66,0x19,0x25,0xeb,0x35,0xef,0xbc,0x4e,0x50,0x34,0xcf,0x32,0xbf,0x67,0xef,
0x96,0x35,0xdb,0x3e,0x41,0x2f,0xea,0x0c,0xee,0xe0,0xcf,0x10,0x15,0x4d,0x36,0x3a,
0x0b,0x11,0xb4,0xbb,0xab,0xfc,0x3c,0x2d,0x02,0x0b,0x0f,0xad,0x36,0xc5,0xe5,0x5e,
0xb1,0x01,0x19,0x8a,0x12,0xfe,0xcd,0x7a,0x2c,0x6c,0x3c,0x22,0xbd,0x40,0x90,0x34,
0x48,0x06,0x3e,0x9e,0xef,0x76,0x86,0xd0,0x07,0x79,0xc1,0x77,0xb3,0x7f,0xfb,0xf2,
0x28,0xc5,0x61,0x70,0xeb,0x6f,0xa4,0xa2,0x19,0xdc,0x57,0xf6,0xb0,0xe0,0x81,0x74,
0xcd,0xa1,0xdb,0xc8,0x2e,0x96,0xd6,0x43,0x4b,0x48,0xd3,0x6f,0x71,0xa5,0x41,0xe3,
0x21,0x93,0x6b,0x08,0x11,0x4f,0x1a,0xbd,0xa8,0x37,0xac,0xe9,0x62,0x64,0xaf,0x44,
0x6d,0x6e,0xda,0x4a,0x14,0x5c,0xc0,0xea,0xfd,0xc7,0x28,0x1f,0x2b,0xcc,0x73,0x8d,
0x39,0x26,0x76,0x17,0x13,0xb4,0x4b,0x22,0x50,0x31,0x3e,0xcc,0xbb,0x6f,0xbe,0xfa,
};

static const char s_plaintext_2[399+1] = "Lorem ipsum dolor sit amet, consectetur adipiscing elit. Phasellus cursus, tellus at commodo tristique, nisi mi euismod erat, at fringilla ligula quam semper nibh. Cras blandit venenatis venenatis. Curabitur sollicitudin fermentum cursus. Aliquam gravida augue eu tortor commodo, a consectetur nulla convallis. Nullam id mattis purus. Sed nec velit quis magna finibus suscipit. Aenean ornare accumsa";
static const uint8_t s_ciphertext_2[400] = {
0x9b,0xba,0x78,0x51,0x72,0x6b,0x4d,0x16,0x5b,0x16,0x6e,0xb1,0xcd,0x95,0xc7,0xb0,
0xc5,0x4b,0x8c,0x85,0x0e,0xcc,0x35,0xb5,0x3f,0xfb,0xe1,0x4f,0xfb,0x68,0x6c,0x53,
0xac,0x43,0x2e,0x93,0x16,0x01,0x95,0x7d,0xe2,0x5d,0x79,0x90,0xe3,0xc5,0x0e,0xd1,
0xb8,0x54,0xe0,0x9b,0xc9,0xa2,0xe8,0x67,0x2d,0x51,0xe0,0xdf,0x30,0x0e,0xd5,0x62,
0x18,0x05,0xdf,0x7c,0x17,0xa8,0xf1,0x08,0xdc,0xfc,0x26,0xa8,0x8c,0xde,0xd5,0x31,
0x61,0x2f,0x07,0x9d,0x2c,0x11,0xd6,0xfb,0xe5,0x7c,0x71,0x32,0xad,0x7f,0x6f,0x15,
0x62,0x9b,0xba,0x7a,0x76,0x12,0x55,0xfe,0xc6,0x1c,0xf4,0x75,0xe5,0xe4,0x47,0x86,
0xd4,0x41,0x7e,0xf0,0x0d,0xfb,0x74,0x16,0xa5,0x27,0xa5,0xfd,0xbf,0xd7,0xba,0x4c,
0x11,0x4a,0x1e,0x12,0xf6,0x62,0xd1,0x5f,0x21,0xb9,0xbd,0xd6,0x64,0x5c,0x2b,0x34,
0x92,0xd7,0x58,0x4c,0x31,0xb3,0xeb,0x16,0x3d,0xa9,0x79,0x4a,0xf2,0xf1,0xe6,0xb4,
0x99,0x6e,0xbe,0x14,0x3b,0x63,0xea,0xaa,0xce,0x08,0x49,0x1e,0xf8,0xf7,0xa7,0x47,
0xb2,0x0c,0xb0,0x6e,0x92,0xda,0x15,0x8f,0x82,0x8d,0x1c,0xbe,0x4a,0x13,0xec,0xa6,
0xce,0xa4,0xd0,0x9f,0x3e,0x64,0x76,0x70,0xa1,0xd9,0x3d,0x1a,0xa7,0x07,0xa7,0xb2,
0x93,0x16,0xba,0xbf,0xa3,0x3e,0x60,0x14,0x28,0x58,0x4d,0x07,0xb8,0x0c,0x62,0x08,
0xd9,0x48,0x3b,0xf4,0x44,0x90,0xed,0x29,0x02,0x55,0xdf,0x6d,0x00,0x36,0x17,0x5a,
0xf1,0x24,0xe9,0xd1,0x0e,0xbe,0x8c,0xba,0x32,0xba,0x3b,0x97,0xef,0xc1,0xcb,0x5d,
0x7a,0x66,0x19,0x25,0xeb,0x35,0xef,0xbc,0x4e,0x50,0x34,0xcf,0x32,0xbf,0x67,0xef,
0x96,0x35,0xdb,0x3e,0x41,0x2f,0xea,0x0c,0xee,0xe0,0xcf,0x10,0x15,0x4d,0x36,0x3a,
0x0b,0x11,0xb4,0xbb,0xab,0xfc,0x3c,0x2d,0x02,0x0b,0x0f,0xad,0x36,0xc5,0xe5,0x5e,
0xb1,0x01,0x19,0x8a,0x12,0xfe,0xcd,0x7a,0x2c,0x6c,0x3c,0x22,0xbd,0x40,0x90,0x34,
0x48,0x06,0x3e,0x9e,0xef,0x76,0x86,0xd0,0x07,0x79,0xc1,0x77,0xb3,0x7f,0xfb,0xf2,
0x28,0xc5,0x61,0x70,0xeb,0x6f,0xa4,0xa2,0x19,0xdc,0x57,0xf6,0xb0,0xe0,0x81,0x74,
0xcd,0xa1,0xdb,0xc8,0x2e,0x96,0xd6,0x43,0x4b,0x48,0xd3,0x6f,0x71,0xa5,0x41,0xe3,
0x21,0x93,0x6b,0x08,0x11,0x4f,0x1a,0xbd,0xa8,0x37,0xac,0xe9,0x62,0x64,0xaf,0x44,
0x61,0x93,0x91,0x49,0x0f,0xbb,0x83,0xac,0x7e,0xe1,0x71,0x74,0x2e,0x40,0x83,0x6e,
};

static void test_write_aes_file(const uint8_t *pt, size_t pt_len,
			       const uint8_t *ct, size_t ct_len)
{
	void *ciphertext;
	size_t ciphertext_len;
	char prefix[32];

	bool rc = write_aes_file(filename, (char *)s_password, strlen(s_password),
		    pt, pt_len);
	assert(rc);

	assert(bu_read_file(filename, &ciphertext, &ciphertext_len, 1024));
	assert(ciphertext);
	assert(ciphertext_len);

	fprintf(stderr, "====================\n");
	fprintf(stderr, "ENCRYPT TEST:\n");
	fprintf(stderr, " plaintext (%d bytes): %s\n", (int )pt_len, pt);
	sprintf(prefix, " ciphertext(%d bytes)", (int )ciphertext_len);
	dumphex(prefix, ciphertext, ciphertext_len);
	fprintf(stderr, "====================\n\n");

	assert(ct_len == ciphertext_len);
	assert(!memcmp(ct, ciphertext, sizeof(ct_len)));

	int rcv = unlink(filename);
	assert(rcv == 0);

	free(ciphertext);
}

static void test_read_aes_file(const uint8_t *ct, size_t ct_len,
			       const uint8_t *pt, size_t pt_len)
{
	char prefix[32];

	bool rc = bu_write_file(filename, ct, ct_len);
	assert(rc);

	cstring *plaintext = read_aes_file(filename, (char *)s_password,
			   			   strlen(s_password), ct_len);

	fprintf(stderr, "====================\n");
	fprintf(stderr, "DECRYPT TEST:\n");
	sprintf(prefix, " ciphertext(%d bytes)", (int )ct_len);
	dumphex(prefix, ct, ct_len);
	fprintf(stderr, " plaintext (%d bytes): %s\n", (int )pt_len, pt);
	fprintf(stderr, "====================\n\n");

	assert(NULL != plaintext);
	assert(pt_len == plaintext->len);
	assert(!memcmp(pt, plaintext->str, pt_len));

	int rcv = unlink(filename);
	assert(rcv == 0);

	cstr_free(plaintext, true);
}

static void test_encryption()
{
	test_write_aes_file((const uint8_t *)s_plaintext_0, strlen(s_plaintext_0),
			   s_ciphertext_0, sizeof(s_ciphertext_0));

	test_write_aes_file((const uint8_t *)s_plaintext_1, strlen(s_plaintext_1),
			   s_ciphertext_1, sizeof(s_ciphertext_1));

	test_write_aes_file((const uint8_t *)s_plaintext_2, strlen(s_plaintext_2),
			   s_ciphertext_2, sizeof(s_ciphertext_2));
}

static void test_decryption()
{
	test_read_aes_file(s_ciphertext_0, sizeof(s_ciphertext_0),
			   (uint8_t *)s_plaintext_0, strlen(s_plaintext_0));

	test_read_aes_file(s_ciphertext_1, sizeof(s_ciphertext_1),
			   (uint8_t *)s_plaintext_1, strlen(s_plaintext_1));

	test_read_aes_file(s_ciphertext_2, sizeof(s_ciphertext_2),
			   (uint8_t *)s_plaintext_2, strlen(s_plaintext_2));
}

int main(int argc, char **argv)
{
	test_encryption();
	test_decryption();

	return 0;
}
